// ▼▼ 設定項目 ▼▼
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();
const SHEET_NAME = 'Users';
const CHANNEL_ACCESS_TOKEN = 'ここにさっきコピーした長いアクセストークンを貼る';
const LIFF_URL = 'https://liff.line.me/あなたのLIFF_ID'; // 会員証ミニアプリのURL
// ▲▲▲▲▲▲▲▲▲▲

function doPost(e) {
  const json = JSON.parse(e.postData.contents);

  // 分岐：LINEプラットフォームからの通知（Webhook）か、ミニアプリからのAPI呼び出し名か？
  if (json.events) {
    // A. LINEからの通知（友だち追加など）の場合
    return handleWebhook(json);
  } else {
    // B. ミニアプリからのAPI呼び出しの場合（前回の処理）
    return handleApi(json);
  }
}

// -------------------------------------------------------
// A. Webhook処理（友だち追加時の処理）
// -------------------------------------------------------
function handleWebhook(json) {
  const events = json.events;
  
  events.forEach(event => {
    // 「友だち追加」または「ブロック解除」された時
    if (event.type === 'follow') {
      const userId = event.source.userId;
      
      // 1. プロフィール情報をLINEから取得
      const profile = getUserProfile(userId);
      const displayName = profile ? profile.displayName : 'Guest';

      // 2. スプレッドシートに登録（既存ならスキップ）
      getOrCreateUser(userId, displayName);

      // 3. あいさつメッセージ（会員証のリンク）を送る
      replyMessage(event.replyToken, displayName);
    }
  });

  return ContentService.createTextOutput(JSON.stringify({status: 'ok'}));
}

// ユーザープロフィール取得（Messaging API）
function getUserProfile(userId) {
  const url = 'https://api.line.me/v2/bot/profile/' + userId;
  const options = {
    method: 'get',
    headers: { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN }
  };
  try {
    const res = UrlFetchApp.fetch(url, options);
    return JSON.parse(res.getContentText());
  } catch (e) {
    return null;
  }
}

// 返信メッセージ送信
function replyMessage(replyToken, userName) {
  const url = 'https://api.line.me/v2/bot/message/reply';
  const payload = {
    replyToken: replyToken,
    messages: [
      {
        type: 'text',
        text: `${userName}様、友だち登録ありがとうございます！\n\nPCホスピタル会員証が発行されました。\n以下のボタンからご確認ください。`
      },
      {
        type: 'template',
        altText: '会員証を開く',
        template: {
          type: 'buttons',
          text: '会員証はこちら',
          actions: [
            {
              type: 'uri',
              label: '会員証を表示',
              uri: LIFF_URL
            }
          ]
        }
      }
    ]
  };

  const options = {
    method: 'post',
    headers: {
      'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN,
      'Content-Type': 'application/json'
    },
    payload: JSON.stringify(payload)
  };
  
  UrlFetchApp.fetch(url, options);
}

// -------------------------------------------------------
// B. API処理（ミニアプリからの呼び出し）※前回と同じロジック
// -------------------------------------------------------
function handleApi(data) {
  try {
    const userId = data.userId;
    const displayName = data.displayName || 'No Name';
    
    // 登録 or 取得
    const user = getOrCreateUser(userId, displayName);

    const response = { status: 'success', data: user };
    return ContentService.createTextOutput(JSON.stringify(response))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    const errorResponse = { status: 'error', message: error.toString() };
    return ContentService.createTextOutput(JSON.stringify(errorResponse))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// -------------------------------------------------------
// 共通：ユーザーDB操作
// -------------------------------------------------------
function getOrCreateUser(userId, displayName) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const lastRow = sheet.getLastRow();
  
  // 既存チェック
  if (lastRow > 1) {
    const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === userId) {
        return { userId: data[i][0], name: data[i][1], memberType: data[i][2] };
      }
    }
  }

  // 新規登録
  const newMemberType = 'free';
  const now = new Date();
  sheet.appendRow([userId, displayName, newMemberType, now]);
  
  return { userId: userId, name: displayName, memberType: newMemberType };
}
